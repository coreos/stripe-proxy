<!doctype html>
<html lang="en">
<head>
    <title>Generate Signed Stripe Credentials</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- External Libraries-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9/crypto-js.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9/hmac-sha256.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9/enc-base64.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-animate.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-aria.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-messages.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.js"></script>
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.css">

    <!-- Custom styles -->
    <style>
        .header-row {
            color: rgba(0,0,0,0.54);
        }
    </style>
</head>
<body ng-app="app">
    <div ng-controller="PermissionsPickerController">
        <md-content>
            <md-toolbar class="md-hue-2">
                <h2 class="md-toolbar-tools"><span>Stripe Permissions Token Generator</span></h2>
            </md-toolbar>

            <div layout="row">
                <div flex="33">
                    <div layout="row" layout-padding>
                        <md-input-container>
                            <label>Stripe Private Key:</label>
                            <input ng-model="stripeKey"
                                   type="password"
                                   required>
                        </md-input-container>
                    </div>
                    <md-list>
                        <md-list-item class="header-row">
                            <b flex="60">Resource Name</b>
                            <b flex="20">Read</b>
                            <b flex="20">Write</b>
                        </md-list-item>
                        <md-list-item ng-repeat="permission in permissions"
                                      ng-click="null">
                            <p flex="70">{{ permission.name}}</p>
                            <md-checkbox ng-model="permission.read"
                                         ng-change="updatePermissions(permission, 'read')"
                                         type="checkbox"
                                         aria-label="read"
                                         class="md-primary"
                                         flex="15"></md-checkbox>
                            <md-checkbox ng-model="permission.write"
                                         ng-change="updatePermissions(permission, 'write')"
                                         type="checkbox"
                                         aria-label="write"
                                         class="md-primary"
                                         flex="15"></md-checkbox>
                        </md-list-item>
                    </md-list>

                    <div layout="row" layout-align="end">
                        <md-button class="md-secondary"
                                   ng-click="setAll('read', false); setAll('write', false)">
                            Reset All
                        </md-button>
                        <md-button class="md-primary"
                                   ng-click="generate()"
                                   ng-disabled="stripeKey.length <= 0">
                            Generate
                        </md-button>
                    </div>
                </div>
                <div flex="66">
                    <div style="padding-top: 30px;">
                        <md-input-container>
                            <label>Stripe Credentials</label>
                            <textarea ng-model="stripeCredentials"
                                      disabled></textarea>
                        </md-input-container>
                    </div>
                </div>
            </div>
        </md-content>
    </div>
    <script>
        (function() {
            angular
                .module("app", ['ngMaterial'])
                .constant('Crypto', CryptoJS)
                .controller("PermissionsPickerController", ['$scope', 'Crypto', function($scope, crypto) {
                    $scope.stripeCredentials = "";
                    $scope.stripeKey = "";
                    $scope.permissions = [
                        {name: 'ResourceAll',                  read: false, write: false},
                        {name: 'ResourceBalance',              read: false, write: false},
                        {name: 'ResourceCharges',              read: false, write: false},
                        {name: 'ResourceCustomers',            read: false, write: false},
                        {name: 'ResourceDisputes',             read: false, write: false},
                        {name: 'ResourceEvents',               read: false, write: false},
                        {name: 'ResourceFileUploads',          read: false, write: false},
                        {name: 'ResourceRefunds',              read: false, write: false},
                        {name: 'ResourceTokens',               read: false, write: false},
                        {name: 'ResourceFileUploads',          read: false, write: false},
                        {name: 'ResourceTransfers',            read: false, write: false},
                        {name: 'ResourceTransferReversals',    read: false, write: false},
                        {name: 'ResourceAccount',              read: false, write: false},
                        {name: 'ResourceApplicationFeeRefund', read: false, write: false},
                        {name: 'ResourceApplicationFee',       read: false, write: false},
                        {name: 'ResourceRecipient',            read: false, write: false},
                        {name: 'ResourceCountrySpec',          read: false, write: false},
                        {name: 'ResourceExternalAccount',      read: false, write: false},
                        {name: 'ResourceSource',               read: false, write: false},
                        {name: 'ResourceOrder',                read: false, write: false},
                        {name: 'ResourceOrderReturn',          read: false, write: false},
                        {name: 'ResourceProduct',              read: false, write: false},
                        {name: 'ResourceSKU',                  read: false, write: false},
                        {name: 'ResourceCoupon',               read: false, write: false},
                        {name: 'ResourceInvoice',              read: false, write: false},
                        {name: 'ResourceInvoiceItem',          read: false, write: false},
                        {name: 'ResourcePlan',                 read: false, write: false},
                        {name: 'ResourceSubscription',         read: false, write: false},
                        {name: 'ResourceSubscriptionItem',     read: false, write: false},
                        {name: 'ResourceRadarReview',          read: false, write: false},
                        {name: 'ResourceRadarRule',            read: false, write: false},
                    ];

                    $scope.updatePermissions = function(permission, permissionType) {
                        if (permission.name == 'ResourceAll' && permission[permissionType]) {
                            $scope.setAll(permissionType, permission[permissionType])
                        }
                    };

                    $scope.setAll = function(permissionType, value) {
                        $scope.permissions.forEach(function(permission) {
                            permission[permissionType] = value;
                        });
                    };

                    $scope.generate = function() {
                        var permissionsVector = $scope.permissions.map(function(permission, index) {
                            // Ignore permission value if ResourceAll is set
                            return (!(index > 0 && $scope.permissions[0].read) && permission.read ? 1 : 0) +
                                   (!(index > 0 && $scope.permissions[0].write) && permission.write ? 2 : 0);
                        })
                        .reduce(function(acc, val, index) {
                            console.log(index, val, acc);
                            return acc |= (val << (index * 2));
                        });
                        console.log(permissionsVector.toString(2), permissionsVector.toString(2).length);
                        console.log(permissionsVector);

                        // TODO: Follow same algorithm in 'credentials.Sign' module
                        // Complication: JS does not support 64-bit integers...
                        var mac = crypto.HmacSHA256(permissionsVector.toString(2), $scope.stripeKey);
                        var permissionEncoded = permissionsVector.toString();
                        var macEncoded = crypto.enc.Base64.stringify(mac);
                        var permissionAndMac = [permissionEncoded, macEncoded];

                        $scope.stripeCredentials = permissionAndMac.join("_");
                    };
                }]);
        })();
    </script>
</body>
</html>